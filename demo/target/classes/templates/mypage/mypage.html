<!DOCTYPE html>
<html lang="ko" data-theme="light" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>마이페이지 – kafolio</title>

    <!-- ✅ CSRF 메타 추가: fetch POST용 -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- 공통 CSS -->
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}" />
    <link rel="stylesheet" th:href="@{/css/users/auth-modal.css}" />
    <link rel="stylesheet" th:href="@{/css/mypage/mypage-modal.css}" />

    <!-- 전용 JS (있으면 사용, 없어도 무방) -->
    <script defer th:src="@{/js/mypage/mypage.js}"></script>
</head>

<body>
    <!-- 공통 헤더 -->
    <div th:replace="fragments/header :: header('mypage')"></div>

    <!-- 본문 -->
    <div class="admin-shell">
        <!-- 사이드바 -->
        <aside class="nav-rail">
            <div class="org-name">마이페이지</div>
            <nav class="rail-menu" id="sidebar">
                <a href="/mypage/home" class="rail-item is-active"><span class="dot"></span>홈</a>
                <a href="/mypage/team" class="rail-item"><span class="dot"></span>팀 참여 정보</a>
                <a href="/mypage/withdraw" class="rail-item"><span class="dot"></span>회원 탈퇴</a>
            </nav>
        </aside>

        <!-- 메인 -->
        <main class="page">
            <div class="page-header">
                <div class="page-titles">
                    <h1>마이페이지</h1>
                </div>
            </div>

            <!-- 프로필 카드 -->
            <section class="panel profile-panel">
                <div class="profile-card">
                    <div class="avatar">
                        <!-- 아바타: 이중 분기(엘비스/삼항 없이 안전 렌더) -->
                        <img th:if="${form != null and form.profileImgUrl != null and !#strings.isEmpty(form.profileImgUrl)}"
                            th:src="${form.profileImgUrl}" alt="프로필 이미지" />
                        <img th:unless="${form != null and form.profileImgUrl != null and !#strings.isEmpty(form.profileImgUrl)}"
                            th:src="@{/images/avatar-default.png}" alt="기본 프로필 이미지" />
                    </div>

                    <div class="who">
                        <!-- 이름 + (남)/(여) -->
                        <h2>
                            <span th:text=" ${form != null && form.name != null ? form.name : '사용자'}">사용자</span>
                            <span th:if="${form != null and form.gender == 'M'}">(남)</span>
                            <span th:if="${form != null and form.gender == 'W'}">(여)</span>
                        </h2>

                        <div class="email">
                            <span
                                th:text="'이메일 : ' + ${form != null && form.email != null ? form.email : ''}">user@example.com</span>
                        </div>
                        <div class="birth">
                            <span th:if="${form?.birth != null}"
                                th:text="'생년월일 : ' + ${#temporals.format(form.birth, 'yyyy.MM.dd')}">1999.01.01</span>
                            <span th:unless="${form?.birth != null}">생년월일 미등록</span>
                        </div>

                        <div class="github">
                            <span>GitHub : </span>

                            <!-- 주소가 있을 때 -->
                            <a th:if="${form?.githubUrl != null and !#strings.isEmpty(form.githubUrl)}"
                                th:href="${form.githubUrl}" target="_blank" rel="noopener" th:text="${form.githubUrl}">
                                https://github.com/username
                            </a>

                            <!-- 주소가 없을 때 -->
                            <span th:unless="${form?.githubUrl != null and !#strings.isEmpty(form.githubUrl)}"
                                th:text="'미등록'">
                                미등록
                            </span>
                        </div>


                        <!-- 포지션 칩: 영어 → 한글 매핑 -->
                        <div class="positions">
                            <div class="pos-cards" aria-label="희망 직무">
                                <div class="pos-card" th:each="pos : ${form.positions}">
                                    <span th:switch="${pos}">
                                        <span th:case="'FRONTEND'">프론트엔드</span>
                                        <span th:case="'BACKEND'">백엔드</span>
                                        <span th:case="'FULLSTACK'">풀스택</span>
                                        <span th:case="'MOBILE'">모바일</span>
                                        <span th:case="*" th:text="${pos}">기타</span>
                                    </span>
                                </div>

                                <!-- 포지션 비었을 때 예시 칩 -->
                                <div class="pos-card ghost"
                                    th:if="${form == null or form.positions == null or form.positions.isEmpty()}">
                                    <span>프론트엔드</span><span class="badge">예시</span>
                                </div>
                                <div class="pos-card ghost"
                                    th:if="${form == null or form.positions == null or form.positions.isEmpty()}">
                                    <span>백엔드</span><span class="badge">예시</span>
                                </div>
                            </div>
                        </div>

                        <!-- 액션 버튼 -->
                        <div class="profile-actions">
                            <button type="button" class="btn" id="btnOpenProfile">
                                프로필 수정
                            </button>
                            <button type="button" class="btn" id="btnOpenPassword">
                                비밀번호 수정
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 현황 (하드코딩 예시) -->
            <section class="panel">
                <div class="panel-head">
                    <h2>나의 현황</h2>
                </div>
                <div class="stat-grid">
                    <!-- 포트폴리오 카드 -->
                    <article class="stat-card">
                        <div class="stat-top">
                            <div class="stat-title">포트폴리오</div>
                            <div class="stat-badge">총 개수</div>
                        </div>
                        <div class="stat-num">3</div>
                        <ul class="recent-list">
                            <li><a href="#">Landing Page 개선</a></li>
                            <li><a href="#">Admin UI 디자인</a></li>
                            <li><a href="#">React 프로젝트</a></li>
                        </ul>
                        <div class="stat-foot">
                            <a class="link" href="#">더보기</a>
                        </div>
                    </article>

                    <!-- 폴리오 카드 -->
                    <article class="stat-card" id="folio-stat-card">
                        <div class="stat-top">
                            <div class="stat-title">Folio</div>
                            <div class="stat-badge">총 개수</div>
                        </div>
                        <div class="stat-num" id="folio-count">0</div>

                        <div class="two-col" id="folio-two-col">
                            <div class="col">
                                <div class="col-title">임시저장</div>
                                <ul class="recent-list" id="folio-draft-list">
                                    <li class="ghost">임시저장 없음</li>
                                </ul>
                            </div>
                            <div class="col">
                                <div class="col-title">업로드</div>
                                <ul class="recent-list" id="folio-pub-list">
                                    <li class="ghost">업로드 없음</li>
                                </ul>
                            </div>
                        </div>

                        <div class="stat-foot">
                            <button id="folio-more-btn" class="inbtn">
                                더보기
                            </button>
                        </div>
                    </article>
                </div>
            </section>
        </main>
    </div>

    <!-- ===== 모달: 프로필 수정 ===== -->
    <div class="kf-editmodal" id="profileModal" aria-hidden="true" style="display: none">
        <div class="kf-editmodal__overlay" id="ovProfile" aria-label="닫기"></div>
        <div class="kf-editmodal__dialog" role="dialog" aria-modal="true" aria-labelledby="editProfileTitle">
            <div class="kf-editmodal__header">
                <div id="editProfileTitle" class="kf-editmodal__title">
                    프로필 수정
                </div>
                <button type="button" class="kf-editmodal__close" id="btnCloseProfile" aria-label="닫기">
                    ×
                </button>
            </div>

            <!-- 사진 업로드 미사용: 파일 입력 제거, 기존 이미지 경로 hidden만 유지 -->
            <form th:action="@{/mypage/settings}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <table class="kf-formtable">
                    <tbody>
                        <tr>
                            <th scope="row">프로필 사진</th>
                            <td>
                                <div style="
                                            display: flex;
                                            gap: 8px;
                                            align-items: center;
                                        ">
                                    <!-- 컨트롤러 파라미터와 동일한 name -->
                                    <input type="file" id="photoInput" name="profileImageFile" accept="image/*" />
                                </div>

                                <!-- 미리보기: 기존/기본 이미지 표시 -->
                                <div style="margin-top: 8px">
                                    <img id="previewImage" alt="미리보기" style="
                                                max-width: 120px;
                                                max-height: 120px;
                                                display: block;
                                            " th:src="${form != null and form.profileImgUrl != null and !#strings.isEmpty(form.profileImgUrl)
                    ? form.profileImgUrl : '/images/avatar-default.png'}" />
                                </div>

                                <!-- 서버에서 새 파일이 없으면 이 hidden 값이 유지됨 -->
                                <input type="hidden" name="profileImgUrl"
                                    th:value="${form != null and form.profileImgUrl != null ? form.profileImgUrl : ''}" />
                                <small class="hint">이미지 선택만 해도 미리보기가 보입니다.
                                    ‘저장’을 누르면
                                    업로드/반영됩니다.</small>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">이메일</th>
                            <td>
                                <input type="text" th:value="${form != null ? form.email : ''}" disabled readonly
                                    class="ro" />
                                <small class="hint">이메일은 변경할 수 없습니다.</small>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">이름</th>
                            <td>
                                <input type="text" name="name" th:value="${form != null ? form.name : ''}"
                                    placeholder="이름을 입력하세요" required />
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">GitHub</th>
                            <td>
                                <input type="text" name="githubUrl" th:value="${form != null ? form.githubUrl : ''}"
                                    placeholder="https://github.com/username" />
                                <small class="hint">http(s):// 포함. 비우면
                                    미표시됩니다.</small>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">희망 분야</th>
                            <td class="check-grid">
                                <label><input type="checkbox" name="positions" value="FRONTEND"
                                        th:checked="${form != null and form.positions != null and form.positions.contains('FRONTEND')}" />
                                    프론트엔드</label>
                                <label><input type="checkbox" name="positions" value="BACKEND"
                                        th:checked="${form != null and form.positions != null and form.positions.contains('BACKEND')}" />
                                    백엔드</label>
                                <label><input type="checkbox" name="positions" value="FULLSTACK"
                                        th:checked="${form != null and form.positions != null and form.positions.contains('FULLSTACK')}" />
                                    풀스택</label>
                                <label><input type="checkbox" name="positions" value="MOBILE"
                                        th:checked="${form != null and form.positions != null and form.positions.contains('MOBILE')}" />
                                    모바일</label>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="kf-editmodal__actions">
                    <button type="button" class="btn" id="btnCancelProfile">
                        취소
                    </button>
                    <button type="submit" class="btn">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== 모달: 비밀번호 수정 ===== -->
    <div class="kf-editmodal" id="passwordModal" aria-hidden="true" style="display: none">
        <div class="kf-editmodal__overlay" id="ovPassword" aria-label="닫기"></div>
        <div class="kf-editmodal__dialog" role="dialog" aria-modal="true" aria-labelledby="editPasswordTitle">
            <div class="kf-editmodal__header">
                <div id="editPasswordTitle" class="kf-editmodal__title">
                    비밀번호 수정
                </div>
                <button type="button" class="kf-editmodal__close" id="btnClosePassword" aria-label="닫기">
                    ×
                </button>
            </div>

            <form th:action="@{/mypage/newpassword}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <table class="kf-formtable">
                    <tbody>
                        <tr>
                            <th scope="row">현재 비밀번호</th>
                            <td>
                                <input type="password" name="currentPassword" placeholder="현재 비밀번호" required />
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">새 비밀번호</th>
                            <td>
                                <input type="password" name="newPassword" placeholder="새 비밀번호" required />
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">새 비밀번호 확인</th>
                            <td>
                                <input type="password" name="confirmNewPassword" placeholder="새 비밀번호 확인" required />
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="kf-editmodal__actions">
                    <button type="button" class="btn" id="btnCancelPassword">
                        취소
                    </button>
                    <button type="submit" class="btn">변경</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Folio 모달 -->
    <div id="folioModal" class="folio-modal" hidden>
        <div class="folio-modal__backdrop" data-close></div>
        <div class="folio-modal__panel" role="dialog" aria-modal="true" aria-labelledby="folioModalTitle">
            <div class="folio-modal__head">
                <h3 id="folioModalTitle">내 폴리오 현황</h3>
                <button class="folio-modal__close" data-close aria-label="닫기">
                    ×
                </button>
            </div>

            <div class="folio-modal__tabs">
                <button class="is-active" data-tab="DRAFT">임시저장</button>
                <button data-tab="PUBLISHED">업로드</button>
            </div>

            <div class="folio-modal__body">
                <ul id="folioListDraft" data-pane="DRAFT" class="folio-modal__list"></ul>
                <ul id="folioListPub" data-pane="PUBLISHED" class="folio-modal__list" hidden></ul>
            </div>

            <div class="folio-modal__foot">
                <button class="inbtn" id="folioMoreDraft" data-more="DRAFT">
                    더보기
                </button>
                <button class="inbtn" id="folioMorePub" data-more="PUBLISHED" hidden>
                    더보기
                </button>
            </div>
        </div>
    </div>
</body>

</html>