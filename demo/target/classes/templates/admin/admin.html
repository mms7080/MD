<!DOCTYPE html>
<html lang="ko" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>관리자 페이지 – kafolio</title>

    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/css/admin/admin.css" />
    <link rel="stylesheet" href="css/users/auth-modal.css" />
    <style>
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 6px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .pagination button {
        border: none;
        border-radius: 6px;
        width: 34px;
        height: 34px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      [data-theme="light"] .pagination button {
        background: #f4f4f6;
        color: #222;
      }
      [data-theme="light"] .pagination button:hover {
        background: #e2e2e6;
      }
      [data-theme="light"] .pagination button.active {
        background: #111;
        color: #fff;
      }
      [data-theme="dark"] .pagination button {
        background: #1f1f25;
        color: #ddd;
      }
      [data-theme="dark"] .pagination button:hover {
        background: #2d2d35;
      }
      [data-theme="dark"] .pagination button.active {
        background: #fff;
        color: #111;
      }
      .pagination button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
    </style>
  </head>

  <body>
    <div th:replace="fragments/header :: header('admin')"></div>

    <div class="admin-shell">
      <aside class="nav-rail">
        <div class="org-name">관리자</div>
        <nav class="rail-menu" id="sidebar">
          <a href="#" class="rail-item is-active" data-page="folio"><span class="dot"></span> 폴리오 관리</a>
          <a href="#" class="rail-item" data-page="profolios"><span class="dot"></span> 포토폴리오 관리</a>
          <a href="#" class="rail-item" data-page="teams"><span class="dot"></span> 팀 관리</a>
          <a href="#" class="rail-item" data-page="users"><span class="dot"></span> 유저 관리</a>
        </nav>
      </aside>

      <main class="page">
        <div class="page-header">
          <div class="page-titles">
            <h1 id="pageTitle">폴리오 관리</h1>
            <p class="sub" id="pageSub">폴리오를 관리합니다.</p>
          </div>
        </div>

        <section class="panel">
          <div class="panel-head">
            <h2 id="panelTitle">폴리오 목록</h2>
            <span class="count" id="panelCount">0건</span>
          </div>

          <div id="panelBody" class="table-wrap"></div>

          <div class="panel-foot" id="panelFoot" style="display: none">
            <span class="hint" id="rangeHint">0건 표시</span>
            <div class="pager">
              <button class="pager-btn" id="prevPage">‹</button>
              <span class="pager-page is-current" id="pageIndex">1</span>
              <button class="pager-btn" id="nextPage">›</button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      /* ========================== 기본 엘리먼트 ========================== */
      const $title = document.getElementById("pageTitle");
      const $sub = document.getElementById("pageSub");
      const $panelTitle = document.getElementById("panelTitle");
      const $panelCount = document.getElementById("panelCount");
      const $panelBody = document.getElementById("panelBody");
      const $panelFoot = document.getElementById("panelFoot");

      /* ========================== 페이지 정보 ========================== */
      const pageMeta = {
        folio: { title: "폴리오 관리", sub: "폴리오를 관리합니다.", panelTitle: "폴리오 목록" },
        profolios: { title: "포토폴리오 관리", sub: "프로젝트 포트폴리오를 관리합니다.", panelTitle: "포토폴리오 목록" },
        teams: { title: "팀 관리", sub: "‘팀 편성’과 ‘팀 관리’ 탭에서 작업하세요.", panelTitle: "팀" },
        users: { title: "유저 관리", sub: "사용자 계정과 권한을 관리합니다.", panelTitle: "유저 목록" },
      };

      /* ========================== 사이드바 ========================== */
      document.querySelectorAll("#sidebar .rail-item").forEach((a) => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          document.querySelectorAll("#sidebar .rail-item").forEach((x) => x.classList.remove("is-active"));
          a.classList.add("is-active");
          loadPage(a.dataset.page);
        });
      });

      /* ========================== 페이지 로딩 ========================== */
      function loadPage(page) {
        const meta = pageMeta[page];
        $title.textContent = meta.title;
        $sub.textContent = meta.sub;
        $panelTitle.textContent = meta.panelTitle;

        if (page === "folio") renderFolio();
        if (page === "profolios") renderProfolios();
        if (page === "users") renderUsers();
        if (page === "teams") renderTeamsPage();
      }

      
      /* ========================== FOLIO 관리 ========================== */
      async function renderFolio(page = 1) {
        $panelFoot.style.display = "flex";
        try {
          const res = await fetch(`/api/admin/folios?page=${page - 1}&size=10`);
          const data = await res.json();
          const folios = data.folios || [];
          const totalPages = data.totalPages || 1;
          const totalItems = data.totalItems || folios.length;

          $panelCount.textContent = `${totalItems}건`;

          $panelBody.innerHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th>썸네일</th>
                  <th>작성자</th>
                  <th>제목</th>
                  <th>템플릿</th>
                  <th>상태</th>
                  <th>작성일</th>
                  <th class="th-actions">관리</th>
                </tr>
              </thead>
              <tbody>
                ${
                  folios.length === 0
                    ? `<tr><td colspan="8" style="text-align:center;color:#888;">등록된 폴리오가 없습니다.</td></tr>`
                    : folios.map(f => `
                      <tr>
                        <td><img src="${f.thumbnail || "https://picsum.photos/seed/folio/80/50"}" style="width:80px;height:50px;object-fit:cover;border-radius:4px;"></td>
                        <td>${f.user ? f.user.name : "미지정"}</td>
                        <td>${f.title}</td>
                        <td>${f.template}</td>
                        <td>${f.status}</td>
                        <td>${f.createdAt}</td>
                        <td class="td-actions">
                          <button class="btn danger" data-act="delete" data-id="${f.id}">삭제</button>
                        </td>
                      </tr>
                    `).join("")
                }
              </tbody>
            </table>
          `;

          // 페이지네이션
          const startPage = Math.max(1, page - 2);
          const endPage = Math.min(totalPages, startPage + 4);
          let paginationHTML = `
            <div style="width:100%;display:flex;flex-direction:column;align-items:center;">
              <div class="pagination">
                <button id="prevFolioPage" ${page === 1 ? "disabled" : ""}>‹</button>
          `;

          for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<button class="${i === page ? "active" : ""}" data-page="${i}">${i}</button>`;
          }

          paginationHTML += `<button id="nextFolioPage" ${page >= totalPages ? "disabled" : ""}>›</button></div></div>`;
          $panelFoot.innerHTML = paginationHTML;

          document.querySelectorAll(".pagination button[data-page]").forEach((btn) => {
            btn.addEventListener("click", () => renderFolio(Number(btn.dataset.page)));
          });
          document.getElementById("prevFolioPage").addEventListener("click", () => page > 1 && renderFolio(page - 1));
          document.getElementById("nextFolioPage").addEventListener("click", () => page < totalPages && renderFolio(page + 1));

          document.querySelectorAll('[data-act="delete"]').forEach((btn) => {
            btn.addEventListener("click", async () => {
              if (!confirm("정말 이 폴리오를 삭제하시겠습니까?")) return;
              const id = btn.dataset.id;
              const res = await fetch(`/api/admin/folios/${id}`, { method: "DELETE" });
              const result = await res.json();
              if (result.success) {
                alert("폴리오가 삭제되었습니다.");
                renderFolio(page);
              } else alert("삭제 실패: " + (result.message || "알 수 없는 오류"));
            });
          });
        } catch (err) {
          console.error(err);
          alert("폴리오 데이터를 불러오지 못했습니다.");
        }
      }


      function renderProfolios() {
        $panelFoot.style.display = "none";
        $panelBody.innerHTML = "<p>포토폴리오 관리 페이지입니다.</p>";
        $panelCount.textContent = "0건";
      }

      /* ========================== USERS 관리 ========================== */
      let currentUserPage = 1;
      const USERS_PER_PAGE = 10;

      async function renderUsers(page = 1) {
        $panelFoot.style.display = "flex";
        try {
          const res = await fetch(`/api/admin/users?page=${page - 1}&size=${USERS_PER_PAGE}`);
          const data = await res.json();

          const usersList = data.users || [];
          const totalPages = data.totalPages || 1;
          const totalItems = data.totalItems || usersList.length;

          currentUserPage = data.currentPage || 1;
          $panelCount.textContent = `${totalItems}명`;

          $panelBody.innerHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th><th>아이디(Username)</th><th>이름</th><th>생년월일</th><th class="th-actions">관리</th>
                </tr>
              </thead>
              <tbody>
                ${
                  usersList.length === 0
                    ? `<tr><td colspan="5" style="text-align:center;color:#888;">표시할 회원이 없습니다.</td></tr>`
                    : usersList
                        .map(
                          (u) => `
                            <tr>
                              <td class="cell-strong">${u.id}</td>
                              <td>${u.username}</td>
                              <td>${u.name}</td>
                              <td>${u.birth || "미입력"}</td>
                              <td class="td-actions">
                                ${
                                  u.deleteStatus === "Y"
                                    ? `<span style="color:#888;">탈퇴됨</span>`
                                    : `<button class="btn danger" data-act="delete" data-id="${u.id}">회원 탈퇴</button>`
                                }
                              </td>
                            </tr>`
                        )
                        .join("")
                }
              </tbody>
            </table>
          `;

          const startPage = Math.max(1, page - 2);
          const endPage = Math.min(totalPages, startPage + 4);

          let paginationHTML = `
            <div style="width:100%;display:flex;flex-direction:column;align-items:center;">
              <div class="pagination">
                <button id="prevPage" ${page === 1 ? "disabled" : ""}>‹</button>
          `;

          for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<button class="${i === page ? "active" : ""}" data-page="${i}">${i}</button>`;
          }

          paginationHTML += `<button id="nextPage" ${page >= totalPages ? "disabled" : ""}>›</button></div></div>`;
          $panelFoot.innerHTML = paginationHTML;

          document.querySelectorAll(".pagination button[data-page]").forEach((btn) => {
            btn.addEventListener("click", () => renderUsers(Number(btn.dataset.page)));
          });

          document.getElementById("prevPage").addEventListener("click", () => page > 1 && renderUsers(page - 1));
          document.getElementById("nextPage").addEventListener("click", () => page < totalPages && renderUsers(page + 1));

          document.querySelectorAll('[data-act="delete"]').forEach((btn) => {
            btn.addEventListener("click", async () => {
              if (!confirm("정말 이 회원을 탈퇴 처리하시겠습니까?")) return;
              const id = btn.dataset.id;
              const res = await fetch(`/api/admin/users/${id}`, { method: "DELETE" });
              const data = await res.json();
              if (data.success) {
                alert("회원이 탈퇴 처리되었습니다.");
                renderUsers(page);
              } else alert("탈퇴 실패: " + (data.message || "알 수 없는 오류"));
            });
          });
        } catch (err) {
          console.error(err);
          alert("유저 데이터를 불러오지 못했습니다.");
        }
      }

      /* ========================== TEAMS 관리 ========================== */
      let allMembers = [];
      let teams = [];
      let editingTeamId = null;

      async function loadMembers() {
        const res = await fetch("/api/admin/users/basic");
        allMembers = await res.json();
      }

      async function loadTeams() {
        const res = await fetch("/api/admin/teams");
        teams = await res.json();
      }

      async function saveTeam(name, memberNames) {
        const memberIds = allMembers.filter((m) => memberNames.includes(m.name)).map((m) => m.id);
        const res = await fetch("/api/admin/teams", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, memberIds }),
        });
        if (!res.ok) alert("팀 저장 실패");
        else alert("팀이 저장되었습니다!");
        await loadTeams();
        renderTeamsPage("manage");
      }

      async function deleteTeam(id) {
        const res = await fetch(`/api/admin/teams/${id}`, { method: "DELETE" });
        if (res.ok) {
          alert("삭제되었습니다.");
          await loadTeams();
          renderTeamsPage("manage");
        } else alert("삭제 실패");
      }

      async function renderTeamsPage(activeTab = "compose") {
        $panelFoot.style.display = "none";
        await Promise.all([loadMembers(), loadTeams()]);
        $panelCount.textContent = `${teams.length}팀`;

        $panelBody.innerHTML = `
          <div class="tabbar" role="tablist">
            <button class="tab ${activeTab === "compose" ? "is-active" : ""}" data-tab="compose">팀 편성</button>
            <button class="tab ${activeTab === "manage" ? "is-active" : ""}" data-tab="manage">팀 관리</button>
          </div>
          <div id="teamsTabContent"></div>
        `;

        document.querySelectorAll(".tabbar .tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document.querySelectorAll(".tabbar .tab").forEach((b) => b.classList.remove("is-active"));
            btn.classList.add("is-active");
            renderTeamsTab(btn.dataset.tab);
          });
        });

        renderTeamsTab(activeTab);
      }

      function renderTeamsTab(tab) {
        const wrap = document.getElementById("teamsTabContent");
        tab === "compose" ? renderTeamComposer(wrap) : renderTeamListView(wrap);
      }

      function renderTeamComposer(rootEl) {
        rootEl.innerHTML = `
          <div class="team-manager">
            <div class="team-column">
              <h3>회원 목록</h3>
              <input type="search" id="memberSearch" placeholder="회원 검색" />
              <ul id="memberList" class="list-box"></ul>
            </div>
            <div class="team-controls">
              <button id="btnAdd" class="btn">▶</button>
              <button id="btnRemove" class="btn">◀</button>
            </div>
            <div class="team-column">
              <h3>선택된 팀원</h3>
              <ul id="selectedList" class="list-box"></ul>
              <input type="text" id="teamName" placeholder="팀 이름 입력" />
              <button id="btnSaveTeam" class="btn btn-teal full">${editingTeamId ? "팀 수정 완료" : "팀 저장"}</button>
            </div>
          </div>
        `;

        const $memberList = document.getElementById("memberList");
        const $selectedList = document.getElementById("selectedList");
        const $memberSearch = document.getElementById("memberSearch");
        const $teamName = document.getElementById("teamName");

        function renderAllMembers() {
          const selectedNames = [...$selectedList.children].map((li) => li.textContent);
          $memberList.innerHTML = "";
          allMembers.forEach((m) => {
            if (!selectedNames.includes(m.name)) {
              const li = document.createElement("li");
              li.textContent = m.name;
              li.dataset.id = m.id;
              $memberList.appendChild(li);
            }
          });
        }

        function makeSelectable($ul) {
          $ul.addEventListener("click", (e) => {
            if (e.target.tagName === "LI") {
              [...$ul.children].forEach((li) => li.classList.remove("selected"));
              e.target.classList.add("selected");
            }
          });
        }

        document.getElementById("btnAdd").addEventListener("click", () => {
          const sel = $memberList.querySelector(".selected");
          if (sel) $selectedList.appendChild(sel);
        });
        document.getElementById("btnRemove").addEventListener("click", () => {
          const sel = $selectedList.querySelector(".selected");
          if (sel) {
            sel.remove();
            renderAllMembers();
          }
        });
        document.getElementById("btnSaveTeam").addEventListener("click", async () => {
          const name = $teamName.value.trim();
          const members = [...$selectedList.children].map((li) => li.textContent);
          if (!name) return alert("팀 이름을 입력하세요!");
          if (members.length === 0) return alert("팀원을 선택하세요!");
          await saveTeam(name, members);
        });

        $memberSearch.addEventListener("input", () => {
          const q = $memberSearch.value.toLowerCase();
          [...$memberList.children].forEach((li) => {
            li.style.display = li.textContent.toLowerCase().includes(q) ? "" : "none";
          });
        });

        makeSelectable($memberList);
        makeSelectable($selectedList);
        renderAllMembers();
      }

      function renderTeamListView(rootEl) {
        rootEl.innerHTML = `
          <div class="team-result">
            <h3>저장된 팀 목록</h3>
            <ul id="teamList"></ul>
          </div>
        `;

        const $teamList = document.getElementById("teamList");
        function draw() {
          $teamList.innerHTML = teams
            .map(
              (t) => `
              <li>
                <div class="team-item">
                  <div class="team-info">
                    <div class="team-name">${t.name}</div>
                    <div class="team-members">${t.members.join(", ")}</div>
                    <div class="team-meta">${t.createdAt}</div>
                  </div>
                  <div class="team-actions">
                    <button class="btn danger" data-act="delete" data-id="${t.id}">삭제</button>
                  </div>
                </div>
              </li>`
            )
            .join("");
          $panelCount.textContent = `${teams.length}팀`;
        }

        $teamList.addEventListener("click", async (e) => {
          if (e.target.dataset.act === "delete") {
            if (!confirm("정말 이 팀을 삭제하시겠습니까?")) return;
            await deleteTeam(Number(e.target.dataset.id));
          }
        });

        draw();
      }

      /* ========================== 초기 로드 ========================== */
      loadPage("folio");
    </script>
  </body>
</html>
