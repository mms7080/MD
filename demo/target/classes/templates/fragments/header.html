<!-- templates/fragments/header.html -->
<!DOCTYPE html>
<html
    lang="ko"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
>
<head>
    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />

    <!-- ✅ 페이지 첫 페인트 전에 저장된 테마를 즉시 적용 (FOUC 방지) -->
    <script>
      (function () {
        try {
          var saved = localStorage.getItem('theme'); // 'light' | 'dark' | null
          if (!saved) {
            // 시스템 설정을 기본값으로
            saved = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches
              ? 'light' : 'dark';
          }
          if (saved === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
          } else {
            document.documentElement.removeAttribute('data-theme');
          }
        } catch (e) {}
      })();
    </script>
</head>

<th:block th:fragment="header(active)">
  <header class="kf-header">
    <div class="kf-header__inner">
      <!-- 왼쪽: 로고 + 1차 메뉴 -->
      <div class="kf-header__left">
        <a class="kf-logo" th:href="@{/}" aria-label="kafolio 홈">
          kafolio <span class="kf-star">✶</span>
        </a>

        <nav class="kf-nav" aria-label="주요 메뉴">
          <ul>
            <li>
              <a th:href="@{/portfolios}"
                 th:classappend="${active}=='portfolio' ? ' is-active' : null">portfolio</a>
            </li>
            <li>
              <a th:href="@{/folios}"
                 th:classappend="${active}=='folio' ? ' is-active' : null">folio</a>
            </li>
            <li>
              <a th:href="@{/notice}"
                 th:classappend="${active}=='notice' ? ' is-active' : null">공지사항</a>
            </li>
          </ul>
        </nav>
      </div>

      <!-- 오른쪽: 테마 토글 + 인증 메뉴 -->
      <div class="kf-header__right">
        <!-- Sun/Moon 순수 CSS 토글 -->
        <label for="themeToggle" class="themeToggle st-sunMoonThemeToggleBtn" aria-label="다크/라이트 전환">
          <input type="checkbox" id="themeToggle" class="themeToggleInput" />
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" stroke="none" aria-hidden="true">
            <mask id="moon-mask">
              <rect x="0" y="0" width="20" height="20" fill="white"></rect>
              <circle cx="11" cy="3" r="8" fill="black"></circle>
            </mask>
            <circle class="sunMoon" cx="10" cy="10" r="8" mask="url(#moon-mask)"></circle>
            <g>
              <circle class="sunRay sunRay1" cx="18" cy="10" r="1.5"></circle>
              <circle class="sunRay sunRay2" cx="14" cy="16.928" r="1.5"></circle>
              <circle class="sunRay sunRay3" cx="6" cy="16.928" r="1.5"></circle>
              <circle class="sunRay sunRay4" cx="2" cy="10" r="1.5"></circle>
              <circle class="sunRay sunRay5" cx="6" cy="3.1718" r="1.5"></circle>
              <circle class="sunRay sunRay6" cx="14" cy="3.1718" r="1.5"></circle>
            </g>
          </svg>
        </label>

        <nav class="kf-auth" aria-label="오른쪽 메뉴">
          <!-- 비로그인 -->
          <div sec:authorize="isAnonymous()">
            <label for="modal-signin" class="kf-link" style="cursor:pointer">로그인</label>
            <label for="modal-signup" class="kf-link" style="cursor:pointer">회원가입</label>
          </div>

          <!-- 로그인(일반) -->
          <div sec:authorize="isAuthenticated() and !hasRole('ADMIN')">
            <a class="kf-link" th:href="@{/mypage/home}">마이페이지</a>
            <form th:action="@{/logout}" method="post" style="display:inline">
              <button type="submit" class="kf-link" style="background:none;border:0;padding:0;cursor:pointer">로그아웃</button>
            </form>
          </div>

          <!-- 로그인(관리자) -->
          <div sec:authorize="hasRole('ADMIN')">
            <a class="kf-link" th:href="@{/admin}">관리자페이지</a>
            <form th:action="@{/logout}" method="post" style="display:inline">
              <button type="submit" class="kf-link" style="background:none;border:0;padding:0;cursor:pointer">로그아웃</button>
            </form>
          </div>
        </nav>
      </div>
    </div>
  </header>

  <!-- ✅ 추가 1: 모달 조각 포함 -->
  <th:block th:replace="~{fragments/modals :: authModals}"></th:block>

  <!-- ✅ 추가 2: 스크립트: 모달 자동 오픈 + 테마 토글 동기화 -->
  <script>
    (function () {
      /* --- 모달 오픈 (기존 유지) --- */
      var modal = new URLSearchParams(window.location.search).get('modal');
      if (modal === 'signin') {
        var r = document.getElementById('modal-signin');
        if (r) r.checked = true; 
      } else if (modal === 'signup') {
        var r2 = document.getElementById('modal-signup');
        if (r2) r2.checked = true;
      }

      /* --- ✅ 테마 토글 저장/복원 --- */
      var cb = document.getElementById('themeToggle');
      if (!cb) return;

      // 현재 문서 테마에 맞게 체크박스 초기화
      var isLight = document.documentElement.getAttribute('data-theme') === 'light';
      cb.checked = isLight;

      cb.addEventListener('change', function () {
        var light = cb.checked;
        if (light) {
          document.documentElement.setAttribute('data-theme', 'light');
          try { localStorage.setItem('theme', 'light'); } catch (e) {}
        } else {
          document.documentElement.removeAttribute('data-theme');
          try { localStorage.setItem('theme', 'dark'); } catch (e) {}
        }
      });

      // 시스템 테마 변경 감지(옵션): 사용자가 저장을 안 한 경우에만 동기화
      try {
        if (!localStorage.getItem('theme') && window.matchMedia) {
          var mq = window.matchMedia('(prefers-color-scheme: light)');
          mq.addEventListener('change', function (e) {
            if (!localStorage.getItem('theme')) {
              if (e.matches) {
                document.documentElement.setAttribute('data-theme', 'light');
                cb.checked = true;
              } else {
                document.documentElement.removeAttribute('data-theme');
                cb.checked = false;
              }
            }
          });
        }
      } catch (e) {}
    })();
  </script>
</th:block>
</html>
