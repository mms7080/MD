<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>계정 찾기</title>

  <!-- 공통 CSS -->
  <link rel="stylesheet" th:href="@{/css/header.css}" />
  <link rel="stylesheet" th:href="@{/css/footer.css}" />
  <link rel="stylesheet" th:href="@{/css/users/auth-modal.css}" />
  <link rel="stylesheet" th:href="@{/css/users/findsign.css}" />
</head>
<body>
  <!-- 공통 헤더 -->
  <th:block th:replace="~{fragments/header :: header('find')}"></th:block>

  <main class="kf-find">
    <h1 class="kf-find__title">계정 찾기</h1>

    <!-- 서버 플래시 메시지 -->
    <div th:if="${message}" class="kf-find__note" th:text="${message}"></div>
    <div th:if="${error}" class="kf-find__note error" th:text="${error}"></div>

    <!-- 탭 토글 (접근성 라디오) -->
    <input id="tab-id" type="radio" name="finder" value="id" th:checked="${#strings.equals(param.tab,'pw')} ? false : true">
    <input id="tab-pw" type="radio" name="finder" value="pw" th:checked="${#strings.equals(param.tab,'pw')}">

    <section class="kf-find__card" aria-label="아이디/비밀번호 찾기">
      <!-- 탭 헤더 -->
      <div class="kf-find__head" role="tablist">
        <label class="kf-find__tab" id="tab-id-label" role="tab" aria-controls="panel-id" aria-selected="true" for="tab-id">아이디 찾기</label>
        <label class="kf-find__tab" id="tab-pw-label" role="tab" aria-controls="panel-pw" aria-selected="false" for="tab-pw">비밀번호 변경</label>
      </div>

      <div class="kf-find__body">
        <!-- 아이디 찾기 -->
        <div id="panel-id" class="kf-find__panel" role="tabpanel" aria-labelledby="tab-id-label">
          <form class="kf-find__form" method="post" th:action="@{/forgot/id}">
            <label class="kf-find__label">이름
              <input class="kf-find__input" type="text" name="name" required autocomplete="name" />
            </label>
            <label class="kf-find__label">이메일
              <input class="kf-find__input" type="email" name="email" required autocomplete="email" />
              <span class="kf-find__help">가입 시 사용한 이메일을 입력하세요.</span>
            </label>
            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
            <button class="kf-find__submit" type="submit">아이디 확인</button>
          </form>
        </div>

        <!-- 비밀번호 변경 1단계 -->
        <div id="panel-pw" class="kf-find__panel" role="tabpanel" aria-labelledby="tab-pw-label">
          <form class="kf-find__form" id="pwVerifyForm" method="post">
            <label class="kf-find__label">이름
              <input class="kf-find__input" type="text" name="name" id="pwName" required autocomplete="name" />
            </label>
            <label class="kf-find__label">아이디
              <input class="kf-find__input" type="text" name="username" id="pwUsername" required autocomplete="username" />
            </label>
            <label class="kf-find__label">이메일
              <input class="kf-find__input" type="email" name="email" id="pwEmail" required autocomplete="email" />
              <span class="kf-find__help">본인확인을 위해 이름/아이디/이메일을 모두 입력하세요.</span>
            </label>
            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
            <button class="kf-find__submit" type="button" id="openPwModal">비밀번호 재설정</button>
          </form>
        </div>
      </div>
    </section>

    <p class="kf-find__help" style="margin-top:12px;">이메일 발송 없이 본인확인(이름·아이디·이메일) 후 새 비밀번호를 설정합니다.</p>
  </main>

  <!-- ===== 비밀번호 설정 모달 ===== -->
  <input type="checkbox" id="pwModalToggle" hidden>
  <div class="kf-modal" aria-hidden="true">
    <label class="kf-modal__overlay" for="pwModalToggle"></label>
    <div class="kf-modal__content" role="dialog" aria-modal="true" aria-labelledby="pw-modal-title">
      <header class="kf-modal__header">
        <h3 id="pw-modal-title">비밀번호 설정</h3>
        <label class="kf-modal__close" for="pwModalToggle" aria-label="닫기">×</label>
      </header>
      <section class="kf-modal__body">
        <div class="kf-modal__confirm">
          <div class="row"><span class="label">이름</span><span class="value" id="modalNameText">-</span></div>
        </div>
        <div class="kf-modal__confirm">
           <div class="row"><span class="label">아이디</span><span class="value" id="modalUsernameText">-</span></div>
        </div>

        <form id="pwResetForm" class="kf-find__form" method="post" th:action="@{/find/password/reset}">
          <input type="hidden" name="name" id="modalName">
          <input type="hidden" name="username" id="modalUsername">
          <input type="hidden" name="email" id="modalEmail">

          <label class="kf-find__label">새 비밀번호
            <input class="kf-find__input" id="newPassword" type="password" name="newPassword"
                   required minlength="10" autocomplete="new-password" placeholder="10자 이상" />
          </label>
          <label class="kf-find__label">새 비밀번호 확인
            <input class="kf-find__input" id="confirmPassword" type="password" required autocomplete="new-password" placeholder="다시 입력" />
          </label>
          <small id="pwStatus" class="kf-find__note" hidden></small>

          <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
          <button id="pwSubmit" class="kf-find__submit" type="submit" disabled>비밀번호 변경</button>
        </form>
      </section>
    </div>
  </div>

  <!-- 공통 푸터 -->
  <th:block th:replace="~{fragments/footer :: footer}"></th:block>

  <!-- ===== 탭 전환 ===== -->
  <script>
    (function () {
      const $ = (s) => document.querySelector(s);
      const tabId = $("#tab-id");
      const tabPw = $("#tab-pw");
      const labelId = $("#tab-id-label");
      const labelPw = $("#tab-pw-label");
      const panelId = $("#panel-id");
      const panelPw = $("#panel-pw");

      function setActive(which) {
        labelId.classList.toggle("is-active", which === "id");
        labelPw.classList.toggle("is-active", which === "pw");
        labelId.setAttribute("aria-selected", String(which === "id"));
        labelPw.setAttribute("aria-selected", String(which === "pw"));
        panelId.classList.toggle("is-active", which === "id");
        panelPw.classList.toggle("is-active", which === "pw");

        // URL 상태 유지
        const url = new URL(window.location.href);
        url.searchParams.set("tab", which);
        window.history.replaceState({}, "", url);
      }
      function initFromURL() {
        const url = new URL(window.location.href);
        const tab = url.searchParams.get("tab") === "pw" ? "pw" : "id";
        (tab === "id" ? tabId : tabPw).checked = true;
        setActive(tab);
      }
      tabId.addEventListener("change", () => tabId.checked && setActive("id"));
      tabPw.addEventListener("change", () => tabPw.checked && setActive("pw"));
      initFromURL();
    })();
  </script>

  <!-- ===== 비밀번호 설정 모달 동작 ===== -->
  <script>
    (function pwModalFlow(){
      const openBtn = document.getElementById('openPwModal');
      const nameEl = document.getElementById('pwName');
      const userEl = document.getElementById('pwUsername');
      const emailEl = document.getElementById('pwEmail');
      const toggle = document.getElementById('pwModalToggle');

      const modalNameText = document.getElementById('modalNameText');
      const modalUsernameText = document.getElementById('modalUsernameText');
      const modalName = document.getElementById('modalName');
      const modalUsername = document.getElementById('modalUsername');
      const modalEmail = document.getElementById('modalEmail');

      const pw = document.getElementById('newPassword');
      const conf = document.getElementById('confirmPassword');
      const status = document.getElementById('pwStatus');
      const submit = document.getElementById('pwSubmit');

      if(!openBtn) return;

      // 1) 다음 → 입력 검증 후 모달 오픈 & 값 주입
      openBtn.addEventListener('click', () => {
        const name = (nameEl.value || '').trim();
        const username = (userEl.value || '').trim();
        const email = (emailEl.value || '').trim();

        if(!name || !username || !email){
          alert('이름, 아이디, 이메일을 모두 입력하세요.');
          return;
        }
        if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
          alert('올바른 이메일 형식이 아닙니다.');
          emailEl.focus(); return;
        }

        modalNameText.textContent = name;
        modalUsernameText.textContent = username;
        modalName.value = name;
        modalUsername.value = username;
        modalEmail.value = email;

        pw.value = ''; conf.value = '';
        status.hidden = true; status.textContent = '';
        submit.disabled = true;

        toggle.checked = true;
        setTimeout(() => pw.focus(), 0);
      });

      // 2) 비밀번호 유효성/일치 체크
      function show(msg, ok){
        status.hidden = false;
        status.textContent = msg;
        status.className = ok ? "kf-find__note" : "kf-find__note error";
        submit.disabled = !ok;
      }
      function check(){
        const a = pw.value.trim();
        const b = conf.value.trim();
        if(!a && !b){ status.hidden = true; submit.disabled = true; return; }
        if(a.length < 10){ show("비밀번호는 10자 이상이어야 합니다.", false); return; }
        if(a !== b){ show("비밀번호가 일치하지 않습니다.", false); return; }
        show("사용 가능한 비밀번호입니다.", true);
      }
      pw?.addEventListener('input', check);
      conf?.addEventListener('input', check);
    })();
  </script>
</body>
</html>
